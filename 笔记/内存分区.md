### 1️⃣ 操作系统视角 vs 用户进程视角

- **操作系统的内存分区**
    
    - 内核把物理内存划分为不同区域：内核空间、用户空间、设备内存等。
        
    - 用户空间通常再分为：代码段（text）、数据段（data）、BSS、堆（heap）、栈（stack）、内存映射区（mmap 区）等。
    - 
 虚拟堆区的概念

- 每个进程都有自己的虚拟地址空间，堆区通常在数据段之后、栈区之前。
    
- 进程使用 `malloc()` 或 `brk()` 扩展堆时，是在自己的虚拟空间中分配一段连续地址。
    
映射到物理内存

- 内核会在物理内存中为进程的堆区分配页（通常 4KB/2MB 页）。
    
- ==**每个进程的虚拟堆映射到的物理页都是独立的**，互不干扰。==

    - **这里说的内存分区，是整个系统视角的划分**。
        
- **每个进程自己的虚拟空间**
    
    - 当操作系统启动一个用户进程时，它会给这个进程分配一个完整的 **虚拟地址空间**。
        
    - 这个虚拟地址空间也按照同样的结构划分：代码段、数据段、堆、栈……
        
    - 但是这些都是 **进程私有的虚拟空间**，==不同进程的堆栈、BSS、代码段在虚拟地址上可以完全相同==，但通过页表映射到物理内存是独立的。
**虚拟地址可以重复，但物理地址不会冲突**，操作系统通过页表做映射和隔离。

当一个程序运行时（比如在操作系统里），系统会把它的内存划成几块区域👇

| 内存区域          | 存放什么                  | 是否自动清零      |
| ------------- | --------------------- | ----------- |
| **代码区（text）** | 程序的指令，比如你写的函数体        | ✅ 固定的机器码，不变 |
| **数据区（data）** | 已经赋初值的全局变量 / 静态变量     | ✅ 已初始化为指定值  |
| **BSS区**      | ==没有赋初值的全局变量 / 静态变量== | ✅ 系统自动清零    |
| **堆区（heap）**  | `malloc` 动态分配的内存      | ❌ 不清零，内容随机  |
| **栈区（stack）** | 函数里的局部变量              | ❌ 不清零，内容随机  |




---

### 2️⃣ 举例理解

假设系统有两个进程 A 和 B：

|区域|进程 A 虚拟空间|进程 B 虚拟空间|物理内存映射|
|---|---|---|---|
|栈|0xBFFF0000|0xBFFF0000|物理内存不同|
|堆|0x08000000+|0x08000000+|物理内存不同|
|数据段|0x08004000|0x08004000|物理内存不同|
|代码段|0x08000000|0x08000000|物理内存不同|
|内核空间|高地址共享|高地址共享|相同物理内存|

- **虚拟地址相同，但物理内存不同**：每个进程的堆、栈、数据段都是独立的。
    
- **内核空间共享**：内核代码和全局数据在所有进程中可访问，但仍由页表保护。
    

---

### 3️⃣ PCB 中的位图作用

PCB（进程控制块）存在==**内核空间**，也就是物理内存中属于 **操作系统管理的区域**，用户态程序是访问不到的==。具体说明如下：

---

### 1️⃣ 内核空间 vs 用户空间

- **内核空间**
    
    - 高特权级（特权级 0），所有进程共享访问。
        
    - 存放内核代码、内核数据、内核栈、PCB、页表等。
        
    - 用户态程序不能直接访问，防止破坏系统稳定性。
        
- **用户空间**
    
    - 低特权级（特权级 3），每个进程有独立的虚拟地址空间。
        
    - 存放代码段、数据段、堆、栈等。
        
    - 用户程序只能通过系统调用访问内核资源。
        

---

### 2️⃣ PCB 的存放形式

- 内核通常会把 PCB 放在内核的 ==**链表或数组** 中，方便调度器遍历。==
    
- 每个 PCB 包含：寄存器上下文、堆栈指针、内存信息、文件表、进程状态等。
    
- 内核在 **上下文切换** 时访问 PCB 保存和恢复进程状态。

- 每个进程 PCB 保存 **用户堆的分配情况**，用位图记录哪些页已经分配、哪些空闲。
    
- 这个位图只是管理自己虚拟地址空间的工具，不代表全局内存分区。
    
- 内核全局内存管理和每个进程的虚拟空间管理是两套不同的机制：
    
    - **全局内核** → 管理物理内存页
        
    - **用户进程** → 管理自己的虚拟堆栈空间
        

---

### 4️⃣ 总结

- 内存分区概念有两层：
    
    1. **系统全局视角**：物理内存划分，内核空间 + 用户空间
        
    2. **进程视角**：虚拟地址空间划分，堆/栈/数据段/代码段，每个进程独立
        
- 所以说“每个进程又有堆栈”，是指在自己 **虚拟空间** 中有私有的堆栈，而不是额外分配一块新的全局物理分区。

