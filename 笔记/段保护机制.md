[[段描述符#当前特权级（CPL）]]

## 代码段 / 数据段保护机制

- **代码段（CS）**：
    
    - 权限等级（DPL）限制执行权限
        
    - 指令只能从允许的特权级执行，否则会触发保护异常
        
- **数据段（DS、ES、FS、GS）**：
    
    - 权限等级限制读取/写入
        
    - 不允许低特权级访问高特权级段（用户态不能直接访问内核态数据段）
        
- **访问检查流程**：
    
    1. 核心就是 cpu检查，**比较 CPU 当前特权级（CPL）和段描述符的特权级（DPL）**，来决定是否允许访问段。
        
    2. 如果权限不足 → 产生 GP（通用保护异常）。


> 类比：不同房间有门禁卡，权限不足的人员不能进入房间。

---

## 3️⃣ 栈段保护机制（SS）

- 栈段有自己的段寄存器 SS。保护模式下栈操作（`push`、`pop`、函数调用）必须：
    
    1. 使用 SS 指向的段
        
    2. 检查访问权限（CPL <= DPL）
        
    3. 防止栈溢出访问段界限外的内存
        
- **栈切换**：
    
    - 如果特权级变化（如用户态 → 内核态），==CPU 会自动切换到对应特权级的栈==（TSS 中指定），保证安全。
        

> 类比：特权级变化时，CPU 自动换了一套安全梯子，用户不能踩内核的梯子。


栈段特别关键，因为==栈操作直接关系到函数调用、返回、特权级切换==，如果栈被滥用，整个系统安全就有问题。
相比之下，CS/DS 主要做 **权限检查**，不会自动切换栈，也不会直接触发特权级相关的系统行为。

# `push` 指令在保护模式和实模式的不同

|特性|实模式|保护模式|
|---|---|---|
|使用的段|SS 段基址 + SP|SS 段选择子缓冲区 + ESP/SP|
|权限检查|无|有 CPL/DPL 权限检查|
|段界限检查|无|检查栈是否越界|
|特权级切换|不涉及|若 CPL 变化 → CPU 自动切换栈（从 TSS 获取新栈地址）|
|溢出行为|不检测|CPU 会触发异常（#SS）|

（就是会严格检查，有保护机制：自动切换，以及会触发异常等等）
- **核心区别**：保护模式下 `push` 更安全，CPU 会严格检查权限和边界，而实模式只是单纯减 SP、写内存。