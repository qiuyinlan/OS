# IO接口

[[端口与INOUT指令]] [[总线]] [[南桥北桥芯片]] [[显卡]] [[硬盘]]

## 什么是 IO 接口

**IO 接口 (I/O Interface)** 是连接 **CPU 与外部设备**的逻辑控制部件，在两者之间进行协调转换。

> 任何不兼容的问题，都可以通过增加一"层"来解决。

在 CPU 和外设之间的这一层就是 **IO 接口**。

## 为什么需要 IO 接口？

### CPU 和外设的不匹配

| 不匹配类型 | CPU | 外设 | IO接口的作用 |
|----------|-----|------|------------|
| **速度** | 很快（GHz）| 很慢（机械设备）| 数据缓冲，减少等待 |
| **电平信号** | TTL 电平 | 各种信号 | 电平转换 |
| **数据格式** | 并行数据 | 并行/串行 | 格式转换 |
| **数据宽度** | 8/16/32/64 位 | 各种宽度 | 宽度适配 |

### IO 接口的比喻

- CPU 和外设**速度不匹配** → IO 接口是**变速箱**
- CPU 和外设**信号不通用** → IO 接口是**翻译机**

## IO 接口的形式

IO 接口形式不限，可以是：

1. **电路板**（如早期的声卡、显卡）
2. **芯片**（如集成在主板上的网卡、声卡）
3. **插槽**（如 PCI/PCIe 插槽）

### 常见 IO 接口

| 接口类型 | 连接的外设 | 位置 |
|---------|----------|------|
| **显卡** | 显示器 | PCI-E 插槽或集成 |
| **声卡** | 音响设备 | PCI 插槽或集成 |
| **网卡** | 网络 | PCI-E 插槽或集成 |
| **USB 控制器** | USB 设备 | 集成在主板芯片组 |
| **SATA 控制器** | 硬盘 | 集成在南桥 |

参见：[[显卡]] [[硬盘]]

## IO 接口的组成

### 硬件部分

做实质具体的工作：

1. **数据缓冲**：解决速度不匹配
2. **格式转换**：并行 ↔ 串行
3. **电平转换**：TTL ↔ 其他信号
4. **时序控制**：协调 CPU 和外设的时序

### 软件部分

控制接口电路工作：

1. **驱动程序**：控制 IO 接口的软件
2. **数据传输程序**：完成内部数据传输

## IO 接口的分类

### 按是否可编程

| 类型 | 特点 | 应用 |
|-----|------|------|
| **不可编程接口** | 功能固定，直接使用 | 简单外设 |
| **可编程接口** | 可通过软件设置功能和模式 | 复杂外设、多设备共享 |

### 可编程接口的优势

- 功能多样，可设置多种工作模式
- 允许多个外设通过同一个接口与 CPU 连接
- 灵活性高

### IO 接口控制编程

通过软件指令（[[端口与INOUT指令]]）告诉 IO 接口：
- 哪些设备连接在此接口上
- 接口的工作模式
- 数据传输方式

## CPU 如何访问 IO 接口？

### 通过总线

[[总线]] 是一组电线，连接 CPU 和各种硬件设备。

```
CPU ← 总线 → IO接口1 → 外设1
         ↓
         → IO接口2 → 外设2
         ↓
         → IO接口3 → 外设3
```

### 问题：多个 IO 接口竞争

同一时刻，CPU 只能和一个 IO 接口通信。当多个接口同时想和 CPU 对话时怎么办？

解决方案：**南桥芯片**

参见：[[南桥北桥芯片]]

## IO 接口的寄存器 - 端口

### 端口 (Port)

IO 接口内部有专用的**寄存器**，用于数据交互。

为了区别于 CPU 内部寄存器，IO 接口中的寄存器称为**端口**。

### 端口的类型

| 端口类型 | 作用 |
|---------|------|
| **数据端口** | 存放要传输的数据 |
| **状态端口** | 反映设备当前状态 |
| **控制端口** | 接收控制命令 |

### 端口编号

每个端口有一个 **端口号**（地址），用于 CPU 访问。

- **8 位端口号**：0x00 ~ 0xFF（256个端口）
- **16 位端口号**：0x0000 ~ 0xFFFF（65536个端口）

参见：[[端口与INOUT指令]]

## IO 端口访问方式

### IN/OUT 指令

CPU 通过专门的 `in` 和 `out` 指令访问端口：

```nasm
in al, dx     ; 从端口 DX 读数据到 AL
out dx, al    ; 将 AL 写入端口 DX
```

### 为什么不能用 MOV？

- 端口**不是内存**
- 需要专门的指令访问
- `in/out` 指令会触发不同的总线信号

参见：[[端口与INOUT指令]]

## 数据传输方式

### 1. 无条件传送

- CPU 随时可以取数据
- **缺点**：效率低，CPU 会空等

### 2. 查询传送 (PIO)

- CPU 先查询设备状态（"准备好没？"）
- 准备好了再读取数据
- **优点**：比无条件传送好
- **缺点**：CPU 仍需轮询

### 3. 中断驱动

- 设备准备好后，主动**打断 CPU**
- CPU 收到中断后再处理数据
- **优点**：CPU 不用轮询，效率高

参见：[[中断]]

### 4. DMA (Direct Memory Access)

- 设备**直接**把数据放到内存
- **CPU 不参与**数据传输
- **优点**：CPU 完全解放，效率最高

### 5. I/O 处理机

- DMA 的升级版
- DMA 控制器能自己做数据组合和校验
- **优点**：功能最强，效率最高

## 实际例子

### 显卡 - IO 接口

显卡是驱动显示器的 IO 接口：

- **硬件部分**：GPU、显存、电路
- **软件部分**：显卡驱动、BIOS

参见：[[显卡]]

### 硬盘控制器 - IO 接口

硬盘控制器是访问硬盘的 IO 接口：

- **端口**：
  - 0x1F0 ~ 0x1F7：数据、状态、控制端口
- **功能**：
  - 发送读写命令
  - 设置 LBA 地址
  - 读取数据

参见：[[硬盘]] [[端口与INOUT指令]]

### 声卡 - IO 接口

- 连接音响设备
- 通过端口控制音频播放

### USB 控制器 - IO 接口

- 连接 USB 设备
- 集成在[[南桥北桥芯片]]中

## IO 接口与 CPU 的连接

```
┌─────────┐
│   CPU   │
└────┬────┘
     │
     ├─── 内部总线 ───┐
     │               │
     │          ┌────┴────┐
     │          │  南桥   │ (I/O Control Hub)
     │          └────┬────┘
     │               │
     │          ┌────┴────────────┐
     │          │                 │
     │        PCI总线           SATA总线
     │          │                 │
     │       ┌──┴──┐          ┌──┴──┐
     │       │显卡 │          │硬盘 │
     │       └─────┘          └─────┘
     │
     └─── (连接内存的路径经过北桥)
```

参见：[[总线]] [[南桥北桥芯片]]

## 总结

### IO 接口的核心作用

1. **协调转换**
   - 速度匹配（缓冲）
   - 信号转换（电平、格式）

2. **提供统一接口**
   - CPU 通过端口访问
   - 不用关心底层硬件差异

3. **支持可编程控制**
   - 通过 in/out 指令控制
   - 灵活配置工作模式

### IO 接口的分类

- **按形式**：电路板、芯片、插槽
- **按功能**：可编程、不可编程
- **按设备**：显卡、声卡、网卡、硬盘控制器...

### CPU 访问 IO 接口

```
CPU → IN/OUT 指令 → 总线 → 南桥 → IO接口 → 外设
```

参见：[[端口与INOUT指令]] [[总线]] [[南桥北桥芯片]]
