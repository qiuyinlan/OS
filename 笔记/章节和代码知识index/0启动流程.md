# 启动流程

[[BIOS]] [[MBR主引导记录]] [[Loader加载器]] [[硬盘]]

## 计算机启动流程

```
上电 → BIOS → MBR → Loader → 操作系统内核
```

### 1. CPU 上电执行

- 计算机一开机，CPU 就会被硬件设计强制指向内存地址空间中 **ROM 芯片对应的位置**（`0xFFFF0`）
- CPU 刚上电时，寄存器状态固定：
  - **CS = 0xF000**
  - **IP = 0xFFF0**
  - 物理地址 = `CS × 16 + IP = 0xFFFF0`

### 2. BIOS 阶段

- **BIOS ROM** 就是指存储 BIOS 程序的那个只读存储芯片
- CPU 开始执行 ROM 芯片中存储的 BIOS 程序代码
- BIOS 完成自检（POST - Power-On Self Test）
  - 检查内存、显卡、硬盘等硬件

### 3. MBR 加载

- BIOS 读取硬盘 MBR 的 **512 字节**数据
- 将其加载到内存的 **`0x7C00`** 地址
- 为什么是 0x7C00？
  - `0x0000 ~ 0x0500` → 中断向量表 (IVT)
  - `0x0500 ~ 0x7BFF` → BIOS 的数据区和缓冲区
  - `0x7C00` 既不覆盖 BIOS，又有足够空间

### 4. 控制权移交

- BIOS 执行跳转指令：`jmp 0x7C00`
- 将 CPU 控制权移交给 MBR 代码

### 5. MBR 执行

- MBR 检查分区表
- 加载操作系统的引导加载程序（[[Loader加载器]]）
- **MBR 用完就没用处了，这时候可以被覆盖**

## BIOS 工作原理

### BIOS 不用加载到内存

- BIOS 存放在主板上的 **ROM 芯片**里
- ROM 里的指令可以直接通过**内存映射**的方式被 CPU 执行
- CPU 上电后直接从 BIOS 芯片取指令，不需要"加载"

### 中断向量表

- **结构固定**：总是位于内存最低端 `0x00000` 开始
- **大小固定**：1KB（`0x00000` 到 `0x003FF`）
- **内容可变**：需要 BIOS 初始化填充

#### 为什么需要填充？

1. **RAM 是易失性的**：断电后内容丢失，开机时是垃圾数据
2. **填充 BIOS 服务程序地址**：将 BIOS 提供的服务例程（如磁盘读取、屏幕显示）的入口地址写入 IVT
3. **建立软件环境基石**：为后续软件（MBR、操作系统）提供可用的基础功能

**在 BIOS 读完 MBR 但还没跳转前，CPU 控制权在哪里，能不能直接执行 0x7C00 的 MBR 代码**。

答案是：**不能**。原因如下：

---

### 1️⃣ CPU 控制权还在 BIOS

- 当 BIOS 调用 INT 13h 读取硬盘扇区时：
    
    - CPU 正在执行 BIOS 的代码。
        
    - CPU 的 **CS:IP 指向 BIOS 内存中的指令**。
        
    - 内存 `0x7C00` 现在只是被写入了 MBR 的内容，但 CPU 并不知道那里有代码，也不会自动去执行它。
        

---

### 2️⃣ CPU 不会自动跳到 MBR

- CPU **没有“自动执行新写入内存”的机制**。
    
- 写入 0x7C00 的 MBR 只是数据，**除非 BIOS 主动跳转到 0x7C00**。
    
- 在 BIOS 内部，通常有类似这样的汇编指令：


### 1️⃣ CPU 不能直接访问硬盘

- CPU 本身只能访问 **内存（RAM）和寄存器**。
    
- 硬盘是一个外设，**不是内存**，CPU 无法像访问 RAM 那样直接“读取”硬盘指令来执行。
    
- 要执行硬盘上的程序，必须先通过某种 **读取指令或控制器（如 BIOS、DMA）** 将数据搬到内存中。
    

---

### 2️⃣ 硬盘存储的只是数据，不是 CPU 指令流

- 硬盘上的扇区是 **磁盘扇区（sector）**，CPU 不认识这个格式。
    
- MBR 只是磁盘上的一段 512 字节数据，CPU 无法直接执行磁盘扇区。
    
- 必须通过 BIOS 或驱动，把它搬到 **CPU 可执行的内存地址**（通常是 0x7C00）。
### 为什么说数据“变成”执行流

- 只是 CPU 的 **访问方式发生了变化**：
    
    - 以前只是作为数据存放在内存中 → CPU 不去执行。
        
    - 现在指针指向它 → CPU 依次解码执行 → “变成了程序”。
        
- 内存里字节的内容没变，只是 **解释方式不同**。
## 内存布局（实模式）

| 地址范围 | 用途 |
|---------|------|
| 0x00000 - 0x003FF | 中断向量表 (IVT) |
| 0x00400 - 0x004FF | BIOS 数据区 |
| 0x00500 - 0x07BFF | 可用区域 |
| 0x07C00 - 0x07DFF | **MBR 加载区** (512 字节) |
| 0x07E00 - 0x9FFFF | 可用内存 |
| 0xA0000 - 0xBFFFF | 显存 |
| 0xC0000 - 0xFFFFF | BIOS ROM |

## 关键概念

### 为什么从硬盘读取 MBR？

从硬盘读取 MBR（主引导记录）而不是直接加载操作系统，是因为：

1. **硬盘可以存储多个操作系统**：MBR 中有分区表，记录了硬盘上有哪些分区以及每个分区的操作系统
2. **BIOS 只负责最基本的启动**：BIOS 只知道如何读取第一个扇区（MBR），不知道操作系统在哪
3. **MBR 是中转站**：
   - BIOS → MBR → Loader → 操作系统内核
   - MBR 决定启动哪个操作系统
   - Loader 负责实际加载内核

参见：[[MBR主引导记录]] [[Loader加载器]]
