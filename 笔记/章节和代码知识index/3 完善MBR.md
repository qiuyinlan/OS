[[硬盘]]
[[CHSLBA]]
[[磁盘盘片-读取扇区CHSLBA]]

[[call和jmp]]

总结：操作显存来打印

在上一章中，我们是通过bios中断来实现打印字符串。现在，我们尝试绕过bios来直接来显示字符。这是为了应对进入保护模式后不能使用bios中断做准备。

能这样的原理是因为==显卡的内存已经编排到了cpu能够寻址的范围之内，==当cpu操作这部分“内存”时，实际上是直接在和显卡打交道。显卡拿到了数据处理之后，显示器最终会按照要求显示这些数据。内存中的显存映射的地址范围如下：

显示器上每个字符占两字节，==低字节是字符ASCII码，高字节是用来控制颜色的==。高字节低4位是字符==前景色==，也就是字符的颜色（RGB是红蓝绿三种颜色的调和，I位表示是否高亮），高字节高4位是字符的==背景色==（RGB是红蓝绿三种颜色的调和，K位控制是否闪烁）。


流程：
A、指定vstart=0x7c00，这是告诉编译器把本程序的起始地址编译为0x7c00；

B、查询并调用bios中断来进行清屏（在之后甚至直接与显卡打交道来实现此功能）；

C、指定段基址，用gs=0xb800，b800是由于显卡内存在内存中的位置决定。gs是随意选择的，也可以选择es，因为我们是用\[段基址：偏移]的形式来访问显卡内存，并用规定的格式向0xb8000（\[段基址：偏移]）开始的位置移入字符与颜色设定；[[显卡]]

D、死循环；填入MBR规定510字节大小剩下的0；固定结尾两字节0x55,0xaa


![[Pasted image 20251127151953.png]]


![[Pasted image 20251127155444.png]]

# 第3章 - 完善 MBR

## 问题 1：CPU 工作原理

### CPU 是如何执行指令的？

[[CPU执行指令]]
[[寄存器]]

- CPU 的三大部分：控制单元、运算单元、存储单元
- CPU 的唯一任务就是执行指令
- 程序计数器 (PC / IP / EIP / RIP) 的作用？
- CPU 如何从内存取指令？
- L1/L2 缓存的作用？

---

## 问题 2：寄存器

### CPU 中有哪些寄存器？

[[寄存器]]

**对程序员可见的寄存器**：
- 通用寄存器：AX、BX、CX、DX、SI、DI、BP、SP
- 段寄存器：CS、DS、SS、ES、FS、GS
- 指令指针：IP / EIP / RIP
- 标志寄存器：FLAGS / EFLAGS

**对程序员不可见的寄存器**：
- GDTR、IDTR、LDTR、TR
- CR0、CR1、CR2、CR3
- DR0-DR7（调试寄存器）

---

## 问题 3：IO 接口

### IO 接口是什么？为什么需要 IO 接口？

[[IO接口]]

- IO 接口的作用：连接 CPU 和外设
- CPU 和外设的不匹配：
  - 速度不匹配 → 数据缓冲
  - 电平信号不匹配 → 电平转换
  - 数据格式不匹配 → 格式转换
- IO 接口的形式：芯片、电路板、插槽
- 可编程接口 vs 不可编程接口

---

## 问题 4：总线

### 总线是什么？有哪些类型？

[[总线]]

- 总线的本质：一组电线（公共线路）
- 数据总线、地址总线、控制总线
- 内部总线 vs 外部总线
- 常见总线标准：
  - PCI / PCI-E
  - SATA
  - USB
- 并行总线 → 串行总线的演进

---

## 问题 5：南桥北桥芯片

### 芯片组的作用是什么？

[[南桥北桥芯片]]

**北桥 (Northbridge / MCH)**：
- 连接高速设备：CPU、内存、显卡
- 现代 CPU 已集成北桥功能

**南桥 (Southbridge / ICH)**：
- 连接低速设备：硬盘、USB、PCI
- 仲裁 IO 接口的竞争
- 集成常用 IO 接口

```
CPU
 ├─ 北桥 (集成到 CPU)
 │   ├─ 内存
 │   └─ 显卡 (PCI-E)
 └─ 南桥 (PCH)
     ├─ 硬盘 (SATA)
     ├─ USB
     └─ PCI 设备
```

---

## 问题 6：端口与 IN/OUT 指令

### 如何访问 IO 设备？

[[端口与INOUT指令]]

- 端口 = IO 接口中的寄存器
- 端口号范围：0x0000 - 0xFFFF
- IN 指令：从端口读数据到 AL/AX
- OUT 指令：将 AL/AX 写入端口
- 为什么不能用 MOV 指令？（内存空间 vs IO 空间）

**常用端口**：
- 0x1F0-0x1F7：硬盘控制器
- 0x3D4-0x3D5：显卡控制器
- 0x20、0xA0：中断控制器

---

## 问题 7：显卡

### 如何操作显卡显示字符？

[[显卡]]

**两种方式**：
1. **BIOS 中断 (int 0x10)**：简单，但慢
2. **直接写显存**：快速，灵活

**显存地址**：
- 文本模式显存：0xB8000
- 每个字符 2 字节：ASCII + 属性
- 屏幕：80 列 × 25 行

**显存格式**：
```
[ASCII 码][属性字节]
         │
         └─ 7654 3210
            KRGB IRGB
            │    │
            │    └─ 前景色 (字符颜色)
            └────── 背景色
```

**示例：白字黑底**
```nasm
mov ax, 0xB800
mov gs, ax
mov byte [gs:0], 'A'    ; 字符
mov byte [gs:1], 0x07   ; 白字黑底
```

---

## 问题 8：中断

### 什么是中断？为什么需要中断？

[[中断]]

**中断的作用**：
- 避免 CPU 轮询等待
- 设备准备好后主动通知 CPU
- 提高效率

**中断类型**：
- 硬件中断（外部）：键盘、硬盘、定时器
- 软件中断（内部）：int 指令
- 异常：除零错误、缺页异常

**中断向量表 (IVT)**：
- 位置：内存 0x00000
- 大小：1KB (256 个中断 × 4 字节)
- 每项内容：段基址 + 偏移地址

**常用 BIOS 中断**：
- INT 0x10：视频服务
- INT 0x13：磁盘服务
- INT 0x16：键盘服务

---

## 问题 9：硬盘

### 如何访问硬盘读取数据？

[[硬盘]]
[[CHSLBA]]

**硬盘端口（主硬盘）**：
- 0x1F0：数据端口
- 0x1F2：扇区数量
- 0x1F3-0x1F5：LBA 地址
- 0x1F6：Device 寄存器
- 0x1F7：状态/命令寄存器

**LBA 寻址**：
- 逻辑块地址，比 CHS 简单
- LBA28：最大 128GB
- LBA48：最大 128PB

**读取硬盘步骤**：
1. 设置扇区数量（0x1F2）
2. 设置 LBA 地址（0x1F3-0x1F6）
3. 发送读命令 0x20（0x1F7）
4. 等待硬盘就绪（检查状态）
5. 从数据端口读取数据（0x1F0）

---

## 问题 10：Loader 加载器

### 为什么需要 Loader？它的作用是什么？

[[Loader加载器]]

**为什么需要 Loader**：
- MBR 只有 512 字节，太小
- 无法完成复杂的启动任务

**两阶段引导**：
```
Stage 1: MBR (512 字节)
  ↓ 加载
Stage 2: Loader (几十 KB)
  ↓ 加载
内核
```

**Loader 的作用**：
1. 加载内核到内存
2. 切换到保护模式
3. 获取内存信息
4. 解析 ELF 文件
5. 设置页表
6. 跳转到内核入口

**Loader 的位置**：
- 硬盘：第 2 扇区开始
- 内存：0x900

---

## 问题 11：MBR 读取 Loader

### MBR 如何从硬盘读取 Loader？

[[MBR主引导记录]]
[[Loader加载器]]
[[硬盘]]

```nasm
; MBR 读取 Loader 到内存
mov eax, 2        ; 起始扇区号（第2扇区）
mov bx, 0x900     ; 加载到内存 0x900
mov cx, 1         ; 读取 1 个扇区
call rd_disk_m_16 ; 调用读硬盘函数
jmp 0x900         ; 跳转到 Loader
```

**rd_disk_m_16 函数**：
- 设置扇区数
- 设置 LBA 地址
- 发送读命令
- 等待硬盘就绪
- 读取数据到内存

---

## 问题 12：数据传输方式

### CPU 和 IO 设备之间有哪些数据传输方式？

[[IO接口]]

1. **无条件传送**：CPU 随时取数据（效率低）
2. **查询传送 (PIO)**：CPU 轮询检查状态
3. **中断驱动**：设备准备好后发送中断
4. **DMA**：设备直接访问内存，CPU 不参与
5. **I/O 处理机**：DMA 的升级版

---

## 问题 13：改进 MBR

### 如何让 MBR 直接操作显卡显示字符？

[[MBR主引导记录]]
[[显卡]]

**原方法：BIOS 中断**
```nasm
mov ah, 0x0E
mov al, 'A'
int 0x10        ; 调用 BIOS
```

**新方法：直接写显存**
```nasm
mov ax, 0xB800
mov gs, ax
mov byte [gs:0], 'A'    ; 字符
mov byte [gs:1], 0x07   ; 属性
```

**优点**：
- 更快
- 更灵活
- 可以实现滚屏等特效

---

## 本章总结

```
启动流程：
BIOS → MBR (0x7C00) → Loader (0x900) → 内核

核心概念：
- IO 接口：CPU 与外设之间的桥梁
- 总线：连接硬件的电线
- 南桥北桥：芯片组管理 IO
- 端口：IO 接口中的寄存器
- 中断：设备主动通知 CPU
- 显卡：操作显存显示字符
- 硬盘：通过端口读取扇区
- Loader：加载内核的引导程序
```
