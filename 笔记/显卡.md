# 显卡

[[IO接口]] [[端口与INOUT指令]] [[BIOS]] [[MBR主引导记录]]

## 什么是显卡

**显卡 (Display Adapter / Video Card)** 是驱动显示器的 [[IO接口]]。

- **别名**：显示适配器、视频卡、图形卡
- **本质**：连接 CPU 和显示器的 IO 接口
- **作用**：将 CPU 的数据转换为显示器能显示的图像

> 无论是液晶显示器还是 CRT 显示器，都是由显卡来控制的。

参见：[[IO接口]]

## 显卡的组成

### 硬件部分

| 组件 | 作用 |
|-----|------|
| **GPU** | 图形处理器，负责图形计算 |
| **显存** | 存储显示数据，对应屏幕像素 |
| **显卡 BIOS** | 固化在显卡上的程序，初始化显卡 |
| **DAC** | 数模转换器，将数字信号转为模拟信号 |

### 软件部分

- **显卡 BIOS**：显卡内部的固化程序
- **显卡驱动**：操作系统中控制显卡的程序

## 显卡 BIOS

### 什么是显卡 BIOS

显卡有自己的 **BIOS (固化的程序)**，用于：

1. **初始化显卡硬件**
2. **提供基础功能接口**
3. **在操作系统加载前提供显示功能**

参见：[[BIOS]]

### 显卡 BIOS 的接口

显卡 BIOS 提供的基础接口：

```nasm
; BIOS 中断 10h - 视频服务
int 10h
```

常用功能号：

| 功能号 (AH) | 作用 |
|-----------|------|
| 0x00 | 设置显示模式 |
| 0x01 | 设置光标形状 |
| 0x02 | 设置光标位置 |
| 0x03 | 读取光标位置 |
| 0x06 | 滚屏 |
| 0x0E | 显示字符（teletype 模式）|
| 0x13 | 显示字符串 |

### 示例：使用 BIOS 显示字符

```nasm
; 通过 BIOS 中断显示字符
mov ah, 0x0E      ; 功能号：显示字符
mov al, 'A'       ; 要显示的字符
int 0x10          ; 调用 BIOS 中断
```

参见：[[MBR主引导记录]]

## 显存 (Video Memory)

### 显存的作用

**显存**是显卡上的内存，用于存储要显示的数据。

- **物理位置**：在显卡上
- **地址映射**：映射到 CPU 的内存地址空间
- **作用**：CPU 写入显存，显卡读取显存并显示到屏幕

### 文本模式显存

在**文本模式**下，显存地址固定：

```
显存起始地址：0xB8000
显存大小：32KB (80列 × 25行 × 2字节)
```

### 显存格式

文本模式下，每个字符占 **2 字节**：

| 偏移 | 内容 | 说明 |
|-----|------|------|
| 第 0 字节 | **ASCII 码** | 要显示的字符 |
| 第 1 字节 | **属性字节** | 颜色、闪烁等属性 |

#### 属性字节格式

```
高 4 位：背景颜色
低 4 位：前景颜色（字符颜色）

7 6 5 4 3 2 1 0
K R G B I R G B
│ └─┬─┘ │ └─┬─┘
│   │   │   └─── 前景色 RGB
│   │   └─────── 前景色高亮
│   └─────────── 背景色 RGB
└─────────────── 闪烁
```

### 颜色表

| 数值 | 颜色 | 数值 | 颜色 |
|-----|------|-----|------|
| 0x0 | 黑色 | 0x8 | 深灰 |
| 0x1 | 蓝色 | 0x9 | 亮蓝 |
| 0x2 | 绿色 | 0xA | 亮绿 |
| 0x3 | 青色 | 0xB | 亮青 |
| 0x4 | 红色 | 0xC | 亮红 |
| 0x5 | 品红 | 0xD | 亮品红 |
| 0x6 | 棕色 | 0xE | 黄色 |
| 0x7 | 浅灰 | 0xF | 白色 |

### 示例：白字黑底

```nasm
; 属性字节 = 0x07
; 背景：0 (黑色)
; 前景：7 (浅灰/白色)

mov byte [0xB8000], 'A'    ; 显示字符 'A'
mov byte [0xB8001], 0x07   ; 白字黑底
```

## 直接操作显存

### 为什么要直接操作显存？

BIOS 中断 vs 直接写显存：

| 方式      | BIOS 中断 `int 10h` | 直接写显存    |
| ------- | ----------------- | -------- |
| **速度**  | 慢（需要调用 BIOS）      | ==快==    |
| **灵活性** | 受 BIOS 限制         | 完全==自由== |
| **复杂度** | 简单                | 需要自己计算地址 |
| **功能**  | 基础功能              | 可以做更多特效  |

### 显存地址计算

```
显存地址 = 0xB8000 + (行号 × 80 + 列号) × 2

示例：
- 第 0 行第 0 列 = 0xB8000 + (0 × 80 + 0) × 2 = 0xB8000
- 第 1 行第 0 列 = 0xB8000 + (1 × 80 + 0) × 2 = 0xB80A0
- 第 0 行第 1 列 = 0xB8000 + (0 × 80 + 1) × 2 = 0xB8002
```

### 示例：直接写显存

```nasm
; 在屏幕第 1 行第 0 列显示 "2 loader"

mov ax, 0xB800
mov gs, ax          ; GS 指向显存段

mov byte [gs:160], '2'    ; 第 1 行第 0 列 (160 = 1*80*2)
mov byte [gs:161], 0x07   ; 白字黑底
mov byte [gs:162], ' '
mov byte [gs:163], 0x07
mov byte [gs:164], 'l'
mov byte [gs:165], 0x07
mov byte [gs:166], 'o'
mov byte [gs:167], 0x07
mov byte [gs:168], 'a'
mov byte [gs:169], 0x07
mov byte [gs:170], 'd'
mov byte [gs:171], 0x07
mov byte [gs:172], 'e'
mov byte [gs:173], 0x07
mov byte [gs:174], 'r'
mov byte [gs:175], 0x07
```

参见：[[实模式]] [[内存分段机制]]

## 显卡端口

显卡除了显存，还有**端口**用于控制。

### 常用显卡端口

| 端口号 | 名称 | 作用 |
|-------|------|------|
| **0x3D4** | 索引寄存器 | 选择要访问的内部寄存器 |
| **0x3D5** | 数据寄存器 | 读写被选中的内部寄存器 |

参见：[[端口与INOUT指令]]

### 显卡内部寄存器

通过端口 0x3D4/0x3D5 访问的内部寄存器：

| 索引 | 寄存器 | 作用 |
|-----|--------|------|
| 0x0E | 光标位置高 8 位 | 设置光标位置 |
| 0x0F | 光标位置低 8 位 | 设置光标位置 |
| 0x0A | 光标开始行 | 设置光标形状 |
| 0x0B | 光标结束行 | 设置光标形状 |
| 0x0C | 显示起始地址高 8 位 | 设置滚屏 |
| 0x0D | 显示起始地址低 8 位 | 设置滚屏 |

### 示例：设置光标位置

```nasm
; 设置光标到 (x, y)
; 光标偏移 = y × 80 + x

; 假设光标偏移在 BX 中

; 1. 设置高 8 位
mov dx, 0x3D4       ; 索引寄存器
mov al, 0x0E        ; 选择光标位置高 8 位寄存器
out dx, al

mov dx, 0x3D5       ; 数据寄存器
mov al, bh          ; 写入高 8 位
out dx, al

; 2. 设置低 8 位
mov dx, 0x3D4
mov al, 0x0F        ; 选择光标位置低 8 位寄存器
out dx, al

mov dx, 0x3D5
mov al, bl          ; 写入低 8 位
out dx, al
```

参见：[[端口与INOUT指令]]

## 显示模式
[[vga]]

### 文本模式 vs 图形模式

| 模式 | 分辨率 | 颜色 | 显存使用 |
|-----|--------|------|---------|
| **文本模式** | 80×25 字符 | 16 色 | 每字符 2 字节 |
| **图形模式** | 640×480 像素 | 256 色 | 每像素 1 字节 |
| **真彩色** | 1024×768+ | 24 位真彩色 | 每像素 3 字节 |

### 文本模式

- **优点**：简单、快速、内存占用小
- **缺点**：只能显示字符，不能显示图像
- **应用**：BIOS、早期操作系统、MBR

### 图形模式

- **优点**：可以显示图像、绘制图形
- **缺点**：复杂、内存占用大
- **应用**：现代操作系统、游戏

## 黑白图形模式

### 像素与显存的关系

在**黑白图形模式**中：

```
显存位 : 屏幕像素 = 1 : 1

- 该位为 1 → 像素点亮（白色）
- 该位为 0 → 像素不亮（黑色）
```

### 保护显示器

> 用黑色壁纸当桌面，才真正是在物理上保护了显示器。

- 黑色像素不发光，减少显示器能耗
- 对于 CRT 显示器，减少电子束轰击
- 对于 OLED 显示器，黑色像素完全关闭

## ASCII 码

**ASCII (American Standard Code for Information Interchange)** 是美国标准信息交换码。

### ASCII 编码

- **范围**：0x00 ~ 0x7F (0-127)
- **可显示字符**：0x20 ~ 0x7E (32-126)
- **控制字符**：0x00 ~ 0x1F, 0x7F

### 常用 ASCII 码

| 字符 | 十进制 | 十六进制 | 字符 | 十进制 | 十六进制 |
|-----|-------|---------|-----|-------|---------|
| 空格 | 32 | 0x20 | 0 | 48 | 0x30 |
| ! | 33 | 0x21 | A | 65 | 0x41 |
| " | 34 | 0x22 | a | 97 | 0x61 |
| \n | 10 | 0x0A | \r | 13 | 0x0D |
| \t | 9 | 0x09 | \0 | 0 | 0x00 |

## 总结

### 显卡的核心作用

1. **IO 接口**
   - 连接 CPU 和显示器
   - 协调速度和信号差异

2. **显存**
   - 存储显示数据
   - CPU 写入，显卡读取并显示

3. **提供接口**
   - BIOS 中断（简单）
   - 直接操作显存（灵活）
   - 端口控制（光标、滚屏）

### 访问显卡的方式

```
方式 1：BIOS 中断
    int 10h → BIOS → 显卡 → 显示器

方式 2：直接写显存
    CPU → 0xB8000 显存 → 显卡 → 显示器

方式 3：端口控制
    in/out 0x3D4/0x3D5 → 显卡内部寄存器
```

### 显存地址

```
文本模式：0xB8000
每字符：2 字节（ASCII + 属性）
屏幕：80 列 × 25 行
```

参见：[[IO接口]] [[端口与INOUT指令]] [[BIOS]]
