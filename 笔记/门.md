## 门（Gate）概念

- 门（Gate）是 **CPU 提供的一种特权级==访问机制**==，本质上是段描述符的特殊类型，用于 ==**控制特权级（CPL）转移**==。
    
- 它允许**低特权代码调用高特权代码**，而不会破坏系统安全。
    

x86 中常见的门类型：

| 门类型            | 用途              |
| -------------- | --------------- |
| Call Gate      | 用户态调用内核函数（系统调用） |
| Interrupt Gate | 外部/内部中断处理       |
| Trap Gate      | 异常处理，返回后标志不清零   |

---

## 2️⃣ 调用门（Call Gate, CG）结构

调用门是一个 **特殊的段描述符**，包含信息：

- **目标段选择子（Segment Selector）**：内核代码段的索引
    
- **目标入口偏移（Offset）**：内核函数入口地址
    
- **目标特权级（DPL）**：允许哪一级程序调用（如用户程序 DPL=3）
    
- **参数个数**（可选）：需要传递给内核的参数个数
    

---

## 3️⃣ 特权级转移如何被保护

当低特权程序（CPL=3）通过调用门调用高特权函数（内核 CPL=0）时，CPU 会做一系列保护检查：

1. **检查访问权限**
    
    - CPU 计算：`max(CPL, RPL)` 与门的 DPL 比较
        
    - 规则：`max(CPL, RPL) ≤ DPL` → 允许通过调用门
        
    - 这样防止用户态随意调用内核内部不允许的函数

## 过门进行特权转移的合法过程

- **用户态程序（CPL=3）想调用内核（CPL=0）函数**
    
- **不能直接跳转到内核段**，直接访问会被 CPU 拒绝（因为 `max(CPL,RPL)=3 > DPL=0`）
    
- **合法方式**：通过 **Call Gate**
    
    1. Call Gate 本身的 DPL=3（允许用户程序调用）
        
    2. 用户程序用段选择子指向 Call Gate，RPL=3
        
    3. CPU 检查：`max(CPL,RPL)=3 ≤ DPL=3` ✅ 允许访问 Call Gate
==是去call gate,让他来搞内核，而call gate本身有级别== 

    4. CPU 执行 Call Gate 内部的逻辑：
        
        - 自动切换堆栈到内核堆栈
            
        - 加载内核 CS 和 DS
            
        - **特权级从 3 降到 0**（CPU 自动完成，不是用户直接修改）
            

> 所以，**通过门访问允许降级**，但前提是“访问门本身”是允许的（门的 DPL ≥ 用户 CPL）。



1. **自动切换堆栈**
    
    - 调用门指定的 **TSS（任务状态段）中内核堆栈地址** 被加载到 SS:ESP
        
    - ==防止用户程序篡改内核堆栈，保护内核运行环境==
        
2. **更新段寄存器**
    
    - CPU 会加载内核代码段（CS）和数据段（DS/ES/SS）
        
    - 确保代码在正确的内核特权空间执行
        
3. **传递参数**
    
    - 调用门可以指定参数个数，CPU 会把参数复制到内核堆栈
        
    - 用户不能直接修改内核堆栈，只能通过规定方式传参
        
4. **返回后恢复 CPL**
    
    - 内核执行完毕，执行 `ret` 指令
        
    - CPU 自动恢复用户态堆栈和段寄存器，CPL 返回原来的值
        

---

### 4️⃣ 总结保护机制

调用门保证了：

1. **不能直接提升权限**：用户程序无法直接写 CS=0 或跳转到内核段
    
2. **堆栈隔离**：切换到内核堆栈执行内核代码
    
3. **受控参数传递**：内核只能读取规定的参数
    
4. **自动返回用户态**：CPL 恢复，保证特权安全
    

---

### 🔹 直观理解

可以想象：

```
用户态 (CPL=3)  --> 调用门 --> 内核态 (CPL=0)
          |                  |
       CPU 检查权限      CPU 切换堆栈、段寄存器
          |                  |
       安全返回            内核执行函数

---