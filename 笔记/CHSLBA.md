[[硬盘]]
[[磁盘盘片-读取扇区CHSLBA]]

# CHS
它是**最早的硬盘寻址方式**，直接对应硬盘的物理结构。
- **柱面（Cylinder）**：相当于盘片上的“同心圆轨道”
    
- **磁头（Head）**：每个盘面一个磁头
    
- **扇区（Sector）**：每个轨道上有多个小弧段（通常 512B）


于是，每个数据块可以用三元组 `(C, H, S)` 来定位。

比如：

`CHS(0, 1, 1) 表示第0柱面、第1磁头、第1扇区。`

CPU 想读一个扇区，就把这个 CHS 地址送给硬盘控制器。



在最早的设计里（CHS模式）：
==扇区在磁道上==
- 每一条磁道（不论外圈还是内圈）都有==**相同数量的扇区**==，比如 63 个；
    
- 每个==扇区固定 512 B==；
    
- 因为外圈周长更长，所以磁道外侧的物理空间被浪费了。
    

🔹 外圈每个扇区的弧长 > 内圈的弧长  
🔹 但逻辑上都只能存 512 B  
➡ 所以外圈浪费了很多磁性材料的存储潜力。
每个扇区逻辑上存储 **512 B（或4 KB）** 数据。  
但在物理层面上，512 B 对应的磁盘表面积其实**极其微小**！

举个例子：

- 一个典型硬盘的盘片直径大约是 **3.5 英寸（≈9 cm）**；
    
- 一张盘面可以有上万个磁道；
    
- 每个磁道上可以有几百到几千个扇区。
    

于是一个扇区的物理尺寸可能只有：

> **长宽约几十到几百纳米级别（0.0000几毫米）！**


> 假设有一个 1TB 的机械硬盘，扇区大小是 512B：

`1TB = 1 × 10¹² 字节 扇区数 = 1TB ÷ 512B ≈ 1.95 × 10⁹ 个扇区`

也就是说，这个硬盘里大概有 **20亿个扇区**！

## 发展

硬盘厂商很快发现外圈可用空间更多，于是引入了 **Zone Bit Recording (==ZBR==)**（也叫分区记录或分区扇区化），让外圈比内圈**每轨存更多扇区**。


- 但是——**BIOS 和操作系统那时候还只能用 CHS 来访问磁盘**。
    

👉 所以厂商就引入了一个“**逻辑映射层**”：

> 让硬盘控制器把物理的 ZBR 结构，**伪装成一个符合 CHS 规律的样子**，供 BIOS 访问。

也就是说：  
**那时仍在用 CHS，但 CHS 只是“表面上的逻辑假象”**。  
BIOS 看到的是固定 63 个扇区，但实际上控制器在底层用 ZBR 自动做了映射。



## CHS问题

早期 CHS 工作得不错，但后来硬盘越来越大，它就“装不下了”。
CHS 的限制来自于它的寄存器位宽：
在早期的 BIOS（中断 13h）中，  
这==三个数（C、H、S）是**通过寄存器传给 BIOS ==的**！

也就是说：

> BIOS 调用中断 13h 时，会把 C/H/S 放进寄存器中，告诉硬盘“我要读这个位置”。

具体分配如下👇

|参数|寄存器|位数|说明|
|---|---|---|---|
|柱面号 (Cylinder)|CH + CL 高 2 位|**10 位**|可表示 0–1023|
|磁头号 (Head)|DH 寄存器|**8 位**|可表示 0–255|
|扇区号 (Sector)|CL 低 6 位|**6 位**|可表示 1–63|
👉 能访问的最大容量：

`1024 * 256 * 63 * 512B ≈ 8GB`


# LBA

## 1. 背景

硬盘上的数据是按扇区（sector）存储的，每个扇区通常是 **512 字节**。早期的硬盘寻址方式是 **CHS（Cylinder/Head/Sector）**，即通过柱面、磁头、扇区来定位数据，但随着硬盘容量变大，CHS 寻址越来越复杂。

于是出现了 **LBA**，它把硬盘看作一个 **连续的扇区数组**，从 0 开始编号：

`扇区编号: 0, 1, 2, 3, ... N-1`

- **优点**：逻辑==简单==，直接用数字表示扇区，无需考虑柱面、磁头。

### 硬盘变大后：BIOS 增强了 INT 13h

硬盘容量超过 8GB 后，传统的 CHS 已经不够用。  
于是 BIOS 增加了 “**扩展版 INT 13h**” ——  
就是我前面说的 AH=42h/43h，用 LBA 寻址。

🧠 这阶段：

- 启动阶段（比如 MBR、Bootloader）仍然使用 **INT 13h**；
    
- 但 BIOS 内部用 **LBA** 代替了 CHS；
    
- 操作系统加载完成后，就不再依赖 BIOS，而使用 **自己的驱动程序** 控制磁盘。


LBA 模式的绝妙之处在于：  
👉 它并没有“新增”寄存器，而是**复用了原来的那几组寄存器**，  
只是把它们的意义重新解释为 **LBA 的不同位段**。

|I/O端口|在 LBA 模式下的含义|对应的 LBA 位|
|---|---|---|
|0x1F2|扇区数|无（依旧相同）|
|0x1F3|LBA LowLBA 低|LBA[7:0]LBA[7：0]|
|0x1F4|LBA MidLBA 中型|LBA[15:8]LBA[15：8]|
|0x1F5|LBA HighLBA 高|LBA[23:16]LBA[23：16]|
|0x1F6|Device装置|含 LBA[27:24] + 主从盘选择 + LBA 模式位（bit6）|

也就是说，  
==原本放 Cylinder / Head / Sector 的寄存器，  
现在被“拼接”成一个 **28 位的 LBA 地址**==：

`LBA[27:24]   → Device寄存器低4位 LBA[23:16]   → 0x1F5 LBA[15:8]    → 0x1F4 LBA[7:0]     → 0x1F3`

总共 4 个寄存器 × 8 位 = 32 位，其中高 4 位未用 → 共 28 位有效。




- **对应关系**：
    
    - 逻辑扇区号 → 硬盘上的物理位置（由硬盘固件映射）
        
    - CPU/操作系统只需要知道 LBA，就能读取/写入数据。


LBA 是**逻辑编号**，它**从 0 开始连续编号整个硬盘所有扇区**，  
==但**编号顺序（映射规则）是硬盘控制器自己决定的**。==

不过，一般情况下，硬盘厂商会按这样的顺序映射：

> **先从同一个柱面里的所有磁头依次编号，再到下一个柱面。**

举个例子👇：

|柱面|磁头（面）|扇区范围（假设每个面 100 扇区）|
|---|---|---|
|0|面0|0–99|
|0|面1|100–199|
|1|面0|200–299|
|1|面1|300–399|
|2|面0|400–499|
|2|面1|500–599|

> 所以你说的「上面 1–100，下面 101–200」非常接近真相！👍  
> 只是顺序上可能是按“磁头先变，再柱面增加”，或者反之，由厂商内部决定。

---

### 为什么操作系统不用关心这个顺序？

因为：

- 操作系统只告诉硬盘：“我要第 N 个扇区。”
    
- 硬盘控制器会自动把这个逻辑编号（LBA）**换算成实际的 CHS 地址**。
    

> 所以，不管它在上面、下面、哪个盘片、哪个磁头——对 OS 来说都一样，都是连续的。

这就是 LBA 的最大意义：  
👉 “屏蔽底层物理结构，让软件以为整个硬盘就是一条线。”

---

### 现代硬盘更复杂了

其实现在的 HDD 已经：

- 不再保证每个轨道的扇区数一样；
    
- 使用了“区域密度记录（ZBR）”，外圈扇区更多；
    
- 控制器内部还有缓存、调度、坏块映射等机制。
    

但对外仍然只暴露一个简单的接口：

`逻辑扇区号 (LBA)  →  物理位置（硬盘控制器内部转换）`




---

## 2. LBA 访问流程（以 ATA 硬盘为例）

读取硬盘扇区通常步骤如下：

1. **选择扇区数**（Sector Count）
    
    - ATA 寄存器：0x1F2
        
    - 指定要读取的扇区数量，0 表示 256 个扇区。
        
2. **写入 LBA 地址到寄存器**
    
    - LBA 0~7 位 → 端口 0x1F3
        
    - LBA 8~15 位 → 端口 0x1F4
        
    - LBA 16~23 位 → 端口 0x1F5
        
    - LBA 24~27 位 → 端口 0x1F6（高 4 位）
        
    - 同时设置 LBA 模式标志和选择主盘/从盘（device register）
        
3. **发送命令**
    
    - READ_SECTOR 命令（0x20）写入 0x1F7
        
4. **等待硬盘就绪**
    
    - 读取 0x1F7 寄存器状态，检查 DRQ（Data Request）位
        
5. **读取数据**
    
    - 使用 `insw` 或 `rep insw` 指令，将硬盘数据读取到内存缓冲区（每次 512 字节）。
        

---

## 3. LBA 地址大小

- 标准 ATA 支持 28 位 LBA → 可寻址 2^28 * 512B ≈ 128 GB
    
- 扩展 ATA（LBA48）支持 48 位 LBA → 可寻址几 TB


## 书里 MBR 阶段读取硬盘时

- 作者需要把内核从硬盘读进内存。
    
- 如果用 CHS，得先知道内核所在的“柱面号、磁头号、扇区号”，太麻烦。
    
- 用 LBA 就简单多了，只需要一个逻辑编号（例如内核从 LBA 1 开始）。
    

**因此：**

`mov eax, 1       ; 从 LBA 1 开始 mov cl, 1        ; 读取 1 个扇区 mov bx, 0x9000   ; 放到 0x9000 内存 call rd_disk_m_16`

非常直观！  
不管硬盘多大多复杂，这个逻辑块 1 就是硬盘上的第二个扇区（第 0 个是 MBR）。


## 现在：UEFI

现代电脑几乎都使用 **UEFI 固件**，  
UEFI 是 BIOS 的继任者，它不再用中断，而是提供 **EFI Boot Services**。

UEFI 环境中：

- CPU 运行在 **保护模式 / 长模式（64位）**
    
- 不再支持 BIOS 中断（包括 INT 13h、INT 10h 等）
    
- 取而代之的是 UEFI 的 API 函数，比如：
    
    `EFI_BLOCK_IO_PROTOCOL->ReadBlocks();`
    
    来直接读取磁盘的块（同样是 LBA 方式）。
    

---

