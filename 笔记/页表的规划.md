## 1️⃣ 目标

操作系统在虚拟内存管理中需要解决两个主要问题：

1. **隔离用户进程**
    
    - 每个用户进程只能访问自己分配的虚拟地址空间，不能访问别的进程的内存，也不能直接访问内核内存。
        
2. **保护内核空间**
    
    - 内核空间只允许CPU在**特权级0（内核态）**访问，用户态（特权级3）禁止访问。
        
    - 防止恶意或错误的用户程序破坏操作系统。
        

---

## 2️⃣ 常见的页表规划策略

### (1) 用户空间与内核空间分离

- 虚拟地址空间==通常划分为两部分==：
    
    1. **用户空间（User Space）**
        
        - 虚拟地址范围：低地址部分（例如x86 32位系统0x00000000 ~ 0xBFFFFFFF）
            
        - 每个用户进程拥有自己的页表映射
            
    2. **内核空间（Kernel Space）**
        
        - 虚拟地址范围：高地址部分（例如0xC0000000 ~ 0xFFFFFFFF）
            
        - 所有进程共享同一份内核页表
            
- 这样设计保证：
    
    - 用户进程无法访问内核内存
        
    - 内核可以访问任何进程的内存（因为内核页表在所有进程的页表中都映射了内核空间）
        

---

### (2) 页表内容规划

- **用户空间页表**：
    
    - 每个用户进程有自己的页表（虚拟页号 → 物理页框号映射）
        
    - 页表条目带有**权限位**：
        
        - 用户/内核（U/S bit）
            
        - 可读/可写/可执行（R/W/X）
            
- **内核空间页表**：
    
    - 所有进程==共享同一部分内核映射==
        
    - 权限限制为内核态可访问
        
    - 用户态访问该部分虚拟地址 → **缺页异常或保护异常**
        

---

### (3) 按需映射和懒加载

- 页表中==只映射实际使用的虚拟页（按需分页）==
    
- 避免一次性为整个虚拟地址空间分配物理页
    
- 优点：
    
    - 节省内存
        
    - 支持大虚拟地址空间（尤其是64位系统）
        

---

### (4) TLB与安全

- MMU使用TLB加速虚拟地址转换
    
- 每个TLB条目包含页表==权限信息==
    
- 如果用户态访问内核页 → TLB检查权限 → 触发异常
    
- 所以TLB也参与虚拟地址访问的安全保护
    

---