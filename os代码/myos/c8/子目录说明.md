# Chapter 8 子目录详解

本章节是《操作系统真象还原》第 8 章 - **内存管理系统**的学习代码。

## 各子目录的功能和演进关系

### 📁 子目录 a - ASSERT 断言测试
**主要内容**: 测试 ASSERT 断言功能

**核心代码** (main.c):
```c
put_str("I am kernel\n");
init_all();
ASSERT(1==2);  // 故意触发断言失败
```

**功能**:
- 测试内核的断言机制是否正常工作
- 当条件不满足时会打印错误信息并停机

**文件数量**: 5 个 C 文件
- 基本的内核框架

---

### 📁 子目录 b - 字符串函数库
**主要内容**: 添加字符串处理函数

**新增内容**:
- ✅ `lib/string.c` - 字符串操作函数库

**功能**:
- 实现 `memset`, `memcpy`, `strcmp` 等基本字符串函数
- 为后续开发提供基础工具函数

**文件数量**: 6 个 C 文件 (+1)

---

### 📁 子目录 c - 位图 (Bitmap) 实现
**主要内容**: 实现位图数据结构，为内存管理做准备

**新增内容**:
- ✅ `lib/kernel/bitmap.c` - 位图实现

**核心代码** (main.c):
```c
struct bitmap btm;
uint8_t test_map[2];  // 16 位的位图
bitmap_init(bitmap);   // 初始化
bitmap_set(bitmap, i, 1);  // 设置位
bitmap_scan(bitmap, 4);     // 扫描连续的空闲位
```

**功能**:
- 位图用于管理内存页的分配状态
- 测试位图的设置、扫描功能
- 是内存管理的核心数据结构

**文件数量**: 7 个 C 文件 (+2)

---

### 📁 子目录 d - 内存管理初始化
**主要内容**: 实现内存管理系统的初始化

**新增内容**:
- ✅ `kernel/memory.c` - 内存管理核心代码

**核心代码** (main.c):
```c
put_str("I am kernel\n");
init_all();  // 初始化内存管理系统
while(1);    // 等待
```

**功能**:
- 初始化物理内存池
- 初始化虚拟内存池
- 建立页表映射机制
- **这是内存管理系统的基础框架**

**文件数量**: 8 个 C 文件 (+3)

---

### 📁 子目录 e - 内存分配函数测试 ⭐
**主要内容**: 实现并测试内存分配函数

**核心代码** (main.c):
```c
put_str("I am kernel\n");
init_all();

// 分配 3 个内核页 (每页 4KB)
void* addr = get_kernel_pages(3);
put_str("\n get_kernel_page start vaddr is ");
put_int((uint32_t)addr);  // 打印分配到的虚拟地址
```

**功能**:
- 实现 `get_kernel_pages()` - 分配内核内存页
- 测试内存分配是否正常工作
- 显示分配的虚拟地址
- **这是第 8 章的最终完整版本**

**文件数量**: 8 个 C 文件

---

## 学习路径建议

```
a (断言测试)
  ↓
b (添加字符串函数)
  ↓
c (实现位图)
  ↓
d (内存管理初始化)
  ↓
e (内存分配测试) ← 最完整版本，推荐使用
```

## 快速对比表

| 子目录 | 核心功能 | 新增文件 | 推荐运行 |
|--------|---------|---------|---------|
| a | 断言测试 | 无 | ⭐ |
| b | 字符串函数 | string.c | ⭐⭐ |
| c | 位图实现 | bitmap.c | ⭐⭐⭐ |
| d | 内存初始化 | memory.c | ⭐⭐⭐⭐ |
| e | 内存分配 | 完善 memory.c | ⭐⭐⭐⭐⭐ |

## 推荐使用

**如果您是初学者**，建议按照 a → b → c → d → e 的顺序逐个运行和学习。

**如果您只想看最终效果**，直接运行子目录 `e`:
```bash
docker run --rm -v /home/xuzichun/boch/bochs:/home/xuzichun/boch bochs-dev bash -c "cd /home/xuzichun/boch/chapter_8 && make SUBDIR=e all && make SUBDIR=e install"
cd /home/xuzichun/boch/bochs/chapter_8
./run.sh
```

## 第 8 章的学习目标

通过这一章，您将学会:
1. ✅ 如何实现内核的断言机制
2. ✅ 如何编写基础的字符串处理函数
3. ✅ 如何用位图管理资源
4. ✅ 如何初始化物理内存池和虚拟内存池
5. ✅ 如何实现内存分配函数 `get_kernel_pages()`
6. ✅ 理解虚拟地址到物理地址的映射

---

## 技术要点

### 位图 (Bitmap)
- 用一个 bit 表示一个内存页的状态 (0=空闲, 1=已用)
- 4GB 内存需要 128KB 的位图 (4GB / 4KB页 / 8位)

### 内存池
- 物理内存池: 管理物理内存页
- 虚拟内存池: 管理虚拟地址空间

### 页表
- 将虚拟地址映射到物理地址
- 4KB 对齐的内存页

---

**本文档帮助您理解 chapter_8 各子目录的关系和作用**
