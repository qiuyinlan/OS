# Makefile é€šç”¨æ¨¡æ¿ä½¿ç”¨è¯´æ˜

## ğŸ¯ ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªæ¨¡æ¿ï¼Ÿ

**é—®é¢˜**ï¼šæ¯ä¸€ç« éƒ½è¦é‡æ–°å†™ Makefile å¤ªéº»çƒ¦ï¼

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨æ™ºèƒ½é€šç”¨æ¨¡æ¿ï¼Œ**è‡ªåŠ¨æ£€æµ‹æ‰€æœ‰æºæ–‡ä»¶**ï¼Œå¤åˆ¶ååªéœ€æ”¹ä¸€è¡Œé…ç½®ï¼

---

## ğŸ“‹ æ¨¡æ¿ç‰¹ç‚¹

### âœ… è‡ªåŠ¨åŒ–ç¨‹åº¦æé«˜
- âœ¨ **è‡ªåŠ¨æ£€æµ‹æ‰€æœ‰ C æ–‡ä»¶**ï¼šä¸ç®¡ä½ æœ‰å¤šå°‘ä¸ª `.c` æ–‡ä»¶ï¼Œéƒ½ä¼šè‡ªåŠ¨ç¼–è¯‘
- âœ¨ **è‡ªåŠ¨æ£€æµ‹æ‰€æœ‰æ±‡ç¼–æ–‡ä»¶**ï¼š`.S` å’Œ `.s` æ–‡ä»¶éƒ½æ”¯æŒ
- âœ¨ **è‡ªåŠ¨å¤„ç†ä¾èµ–**ï¼šæ–°å¢æ–‡ä»¶æ— éœ€ä¿®æ”¹ Makefile
- âœ¨ **å…¼å®¹æ‰€æœ‰ç« èŠ‚**ï¼šä» chapter-2 åˆ° chapter-15 é€šç”¨

### âœ… ç®€å•æ˜“ç”¨
- ğŸ¯ **åªéœ€æ”¹ä¸€è¡Œ**ï¼šä¿®æ”¹ç¡¬ç›˜é•œåƒè·¯å¾„å³å¯
- ğŸ¯ **ä¸€é”®ç¼–è¯‘**ï¼š`make all` æå®šä¸€åˆ‡
- ğŸ¯ **æ¸…æ™°è¾“å‡º**ï¼šæ¯ä¸€æ­¥éƒ½æœ‰ emoji æ ‡è¯†ï¼Œæ¸…æ¥šæ˜äº†

### âœ… åŠŸèƒ½å®Œæ•´
- ğŸ“¦ ç¼–è¯‘ MBR
- ğŸ“¦ ç¼–è¯‘ Loader
- ğŸ“¦ ç¼–è¯‘å†…æ ¸ï¼ˆæ‰€æœ‰ C å’Œæ±‡ç¼–æ–‡ä»¶ï¼‰
- ğŸ“¦ é“¾æ¥ç”Ÿæˆ kernel.bin
- ğŸ“¦ è‡ªåŠ¨å†™å…¥ç¡¬ç›˜é•œåƒ

---

## ğŸš€ ä½¿ç”¨æ­¥éª¤

### æ–¹æ³•ä¸€ï¼šå­¦ä¹ æ–°ç« èŠ‚ï¼ˆæ¨èï¼‰

å‡è®¾ä½ è¦å­¦ä¹  chapter-8ï¼š

```bash
# 1. ä» the_truth_of_operation_system å¤åˆ¶ä»£ç 
cd /home/xuzichun/boch/bochs
cp -r /home/xuzichun/boch/the_truth_of_operation_system/chapter_8/e chapter-8

# 2. å¤åˆ¶ Makefile æ¨¡æ¿
cp Makefile.template chapter-8/Makefile

# 3. å¤åˆ¶ bochsrc é…ç½®ï¼ˆä» chapter-7 å¤åˆ¶ï¼‰
cp chapter-7/bochsrc.disk chapter-8/

# 4. åˆ›å»º build ç›®å½•
mkdir -p chapter-8/build

# 5. ç¼–è¯‘è¿è¡Œ
cd chapter-8
make all
```

**å°±è¿™ä¹ˆç®€å•ï¼** ä¸éœ€è¦ä¿®æ”¹ä»»ä½•ä»£ç ï¼

### æ–¹æ³•äºŒï¼šå¦‚æœç¡¬ç›˜é•œåƒè·¯å¾„ä¸åŒ

å¦‚æœä½ çš„ç¡¬ç›˜é•œåƒä¸åœ¨ `../hd60M.img`ï¼Œéœ€è¦ä¿®æ”¹ä¸€è¡Œï¼š

```bash
# ç¼–è¾‘ Makefile
vim chapter-8/Makefile

# æ‰¾åˆ°ç¬¬ 12 è¡Œï¼Œä¿®æ”¹ä¸ºä½ çš„è·¯å¾„ï¼š
HD60M_PATH = /your/path/to/hd60M.img
```

---

## ğŸ“– Makefile å‘½ä»¤è¯´æ˜

```bash
cd chapter-X

# å®Œæ•´ç¼–è¯‘å¹¶å†™å…¥ç¡¬ç›˜ï¼ˆæœ€å¸¸ç”¨ï¼‰
make all

# åªç¼–è¯‘å¼•å¯¼ç¨‹åº
make boot

# åªç¼–è¯‘å†…æ ¸
make build

# åªå†™å…¥ç¡¬ç›˜
make hd

# æ¸…ç†ç¼–è¯‘æ–‡ä»¶
make clean

# æŸ¥çœ‹å¸®åŠ©
make help

# è°ƒè¯•ï¼šæŸ¥çœ‹æ£€æµ‹åˆ°çš„æ–‡ä»¶
make debug
```

---

## ğŸ” æ¨¡æ¿å·¥ä½œåŸç†

### 1. è‡ªåŠ¨æ£€æµ‹æºæ–‡ä»¶

```makefile
# æŸ¥æ‰¾æ‰€æœ‰ C æ–‡ä»¶ï¼ˆæ’é™¤ build å’Œ .git ç›®å½•ï¼‰
C_SOURCES = $(shell find . -name "*.c" ! -path "./build/*" ! -path "./.git/*")

# æŸ¥æ‰¾æ‰€æœ‰æ±‡ç¼–æ–‡ä»¶
S_SOURCES = $(shell find ./kernel ./lib ./device ... -name "*.S" 2>/dev/null)
```

### 2. è‡ªåŠ¨ç”Ÿæˆç›®æ ‡æ–‡ä»¶

```makefile
# å°† kernel/main.c è½¬æ¢ä¸º build/main.o
C_OBJS = $(patsubst %.c, $(BUILD_DIR)/%.o, $(notdir $(C_SOURCES)))

# å°† lib/kernel/print.S è½¬æ¢ä¸º build/print.o
S_OBJS = $(patsubst %.S, $(BUILD_DIR)/%.o, $(notdir $(S_SOURCES)))
```

### 3. é€šç”¨ç¼–è¯‘è§„åˆ™

```makefile
# ä»»ä½• .c æ–‡ä»¶éƒ½ç”¨è¿™ä¸ªè§„åˆ™ç¼–è¯‘
$(BUILD_DIR)/%.o: %.c
    gcc $(CFLAGS) -o $@ $<

# ä»»ä½• .S æ–‡ä»¶éƒ½ç”¨è¿™ä¸ªè§„åˆ™ç¼–è¯‘
$(BUILD_DIR)/%.o: %.S
    nasm $(ASFLAGS) -o $@ $<
```

---

## ğŸ“Š ä¸æ‰‹åŠ¨ç¼–è¯‘å¯¹æ¯”

| æ–¹å¼ | éœ€è¦ä¿®æ”¹ | æ–°å¢æ–‡ä»¶ | ç¼–è¯‘å‘½ä»¤ |
|------|---------|---------|---------|
| **æ‰‹åŠ¨å‘½ä»¤** | æ¯æ¬¡éƒ½è¦è¾“å…¥å‡ åæ¡å‘½ä»¤ | éœ€è¦æ‰‹åŠ¨æ·»åŠ ç¼–è¯‘å‘½ä»¤ | è¶…çº§éº»çƒ¦ ğŸ˜« |
| **é™æ€ Makefile** | éœ€è¦æ‰‹åŠ¨åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ | éœ€è¦ä¿®æ”¹ OBJS å˜é‡ | æ¯”è¾ƒéº»çƒ¦ ğŸ˜ |
| **æ™ºèƒ½æ¨¡æ¿** | **åªæ”¹ä¸€è¡Œè·¯å¾„** | **è‡ªåŠ¨æ£€æµ‹** | **è¶…çº§ç®€å•** ğŸ˜ |

---

## ğŸ“ ä¸åŒç« èŠ‚çš„å·®å¼‚

### Chapter 2-4ï¼ˆåŸºç¡€ï¼‰
```
chapter-X/
â”œâ”€â”€ boot/
â”‚   â”œâ”€â”€ mbr.S
â”‚   â””â”€â”€ loader.S
â””â”€â”€ kernel/
    â””â”€â”€ main.c
```
**æ¨¡æ¿å¤„ç†**ï¼šè‡ªåŠ¨æ£€æµ‹åˆ° 1 ä¸ª C æ–‡ä»¶ï¼Œ2 ä¸ªå¼•å¯¼æ–‡ä»¶ âœ…

### Chapter 5-7ï¼ˆä¸­æ–­ï¼‰
```
chapter-X/
â”œâ”€â”€ boot/
â”œâ”€â”€ kernel/
â”‚   â”œâ”€â”€ main.c
â”‚   â”œâ”€â”€ init.c
â”‚   â””â”€â”€ interrupt.c
â”œâ”€â”€ device/
â”‚   â””â”€â”€ timer.c
â””â”€â”€ lib/
    â””â”€â”€ kernel/print.S
```
**æ¨¡æ¿å¤„ç†**ï¼šè‡ªåŠ¨æ£€æµ‹åˆ° 4 ä¸ª C æ–‡ä»¶ï¼Œ1 ä¸ªæ±‡ç¼–æ–‡ä»¶ âœ…

### Chapter 8-15ï¼ˆå®Œæ•´ç³»ç»Ÿï¼‰
```
chapter-X/
â”œâ”€â”€ boot/
â”œâ”€â”€ kernel/
â”œâ”€â”€ device/
â”œâ”€â”€ lib/
â”œâ”€â”€ thread/      # æ–°å¢çº¿ç¨‹
â”œâ”€â”€ userprog/    # æ–°å¢ç”¨æˆ·ç¨‹åº
â”œâ”€â”€ fs/          # æ–°å¢æ–‡ä»¶ç³»ç»Ÿ
â””â”€â”€ shell/       # æ–°å¢ shell
```
**æ¨¡æ¿å¤„ç†**ï¼šè‡ªåŠ¨æ£€æµ‹æ‰€æœ‰ç›®å½•çš„æ‰€æœ‰æ–‡ä»¶ âœ…

**æ— è®ºå¤šå°‘æ–‡ä»¶ï¼Œæ¨¡æ¿éƒ½èƒ½è‡ªåŠ¨å¤„ç†ï¼**

---

## ğŸ› ï¸ Docker ç¼–è¯‘æµç¨‹

### å®Œæ•´æµç¨‹ï¼ˆä»¥ chapter-8 ä¸ºä¾‹ï¼‰

```bash
# 1. å‡†å¤‡ä»£ç ï¼ˆåœ¨å®¿ä¸»æœºï¼‰
cd /home/xuzichun/boch/bochs
cp -r /home/xuzichun/boch/the_truth_of_operation_system/chapter_8/e chapter-8
cp Makefile.template chapter-8/Makefile
cp chapter-7/bochsrc.disk chapter-8/
mkdir -p chapter-8/build

# 2. åœ¨ Docker å®¹å™¨ä¸­ç¼–è¯‘
docker run --rm -v /home/xuzichun/boch/bochs:/home/xuzichun/boch bochs-dev bash -c \
  "cd /home/xuzichun/boch/chapter-8 && make all"

# 3. åœ¨å®¿ä¸»æœºè¿è¡Œ bochs
cd /home/xuzichun/boch/bochs/chapter-8
/home/xuzichun/ä¸‹è½½/bochs-2.6.8/bochs -f bochsrc.disk -q
```

### ç®€åŒ–ç‰ˆï¼ˆæ—¥å¸¸å¼€å‘ï¼‰

```bash
# ä¿®æ”¹ä»£ç åé‡æ–°ç¼–è¯‘
docker run --rm -v /home/xuzichun/boch/bochs:/home/xuzichun/boch bochs-dev bash -c \
  "cd /home/xuzichun/boch/chapter-8 && make clean && make all"

# è¿è¡Œ
cd /home/xuzichun/boch/bochs/chapter-8 && /home/xuzichun/ä¸‹è½½/bochs-2.6.8/bochs -f bochsrc.disk -q
```

---

## âš ï¸ å¸¸è§é—®é¢˜

### Q1: ç¼–è¯‘æ—¶æ‰¾ä¸åˆ°å¤´æ–‡ä»¶ï¼Ÿ
**A**: æ£€æŸ¥ Makefile ä¸­çš„ `LIB` å˜é‡ï¼Œç¡®ä¿åŒ…å«äº†æ‰€æœ‰ç›®å½•ï¼š
```makefile
LIB = -I . -I lib/ -I lib/kernel/ -I kernel/ -I device/ ...
```

### Q2: æ–°å¢äº† C æ–‡ä»¶ä½†æ²¡æœ‰ç¼–è¯‘ï¼Ÿ
**A**:
1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨ `build/` æˆ– `.git/` ç›®å½•ï¼ˆä¼šè¢«æ’é™¤ï¼‰
2. è¿è¡Œ `make debug` æŸ¥çœ‹æ£€æµ‹åˆ°çš„æ–‡ä»¶
3. ç¡®ä¿æ–‡ä»¶æ‰©å±•åæ˜¯ `.c` æˆ– `.S`

### Q3: ç¼–è¯‘æŠ¥é”™æ‰¾ä¸åˆ° .S æ–‡ä»¶ï¼Ÿ
**A**: å¯èƒ½æ–‡ä»¶åæ˜¯å°å†™ `.s`ï¼Œæ¨¡æ¿æ”¯æŒä¸¤ç§æ ¼å¼ï¼Œæ£€æŸ¥ VPATH æ˜¯å¦æ­£ç¡®

### Q4: æƒ³çœ‹æ£€æµ‹åˆ°äº†å“ªäº›æ–‡ä»¶ï¼Ÿ
**A**: è¿è¡Œ `make debug` æˆ– `make help`

---

## ğŸ‰ æ€»ç»“

### ä½¿ç”¨æ™ºèƒ½æ¨¡æ¿åçš„å·¥ä½œæµï¼š

1. **å¤åˆ¶ä»£ç **ï¼š`cp -r chapter_X chapter-X`
2. **å¤åˆ¶æ¨¡æ¿**ï¼š`cp Makefile.template chapter-X/Makefile`
3. **å¤åˆ¶é…ç½®**ï¼š`cp chapter-7/bochsrc.disk chapter-X/`
4. **ä¸€é”®ç¼–è¯‘**ï¼š`make all`

**å°±è¿™ä¹ˆç®€å•ï¼** ğŸš€

### ä¼˜åŠ¿ï¼š
- âœ… **èŠ‚çœæ—¶é—´**ï¼šä¸ç”¨æ¯ç« å†™ Makefile
- âœ… **å‡å°‘é”™è¯¯**ï¼šè‡ªåŠ¨æ£€æµ‹ï¼Œä¸ä¼šæ¼æ–‡ä»¶
- âœ… **æ˜“äºç»´æŠ¤**ï¼šæ–°å¢æ–‡ä»¶æ— éœ€ä¿®æ”¹
- âœ… **é€šç”¨æ€§å¼º**ï¼šæ‰€æœ‰ç« èŠ‚éƒ½èƒ½ç”¨

---

**ç°åœ¨å­¦ä¹ æ–°ç« èŠ‚è½»æ¾å¤šäº†ï¼èµ¶ç´§è¯•è¯•å§ï¼** ğŸ’ª
